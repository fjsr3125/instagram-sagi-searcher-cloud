<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagramè©æ¬ºãƒã‚§ãƒƒã‚«ãƒ¼ (Cloudç‰ˆ)</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Instagramè©æ¬ºãƒã‚§ãƒƒã‚«ãƒ¼</h1>
            <p class="subtitle">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦è©æ¬ºã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯ (Cloudç‰ˆ)</p>
        </header>

        <main>
            <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ³ã‚«ãƒ¼ãƒ‰ -->
            {% if accounts %}
            <section class="card accounts-card">
                <h2>Instagramã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ³</h2>
                <div class="accounts-grid">
                    {% for acc in accounts %}
                    <div class="account-item {% if not acc.is_available %}account-exhausted{% endif %}">
                        <div class="account-name">@{{ acc.username }}</div>
                        <div class="account-stats">
                            <span class="follow-count">{{ acc.today_follows }}/60</span>
                            <span class="follow-remaining">
                                {% if acc.is_available %}
                                    æ®‹ã‚Š{{ acc.remaining }}å›
                                {% else %}
                                    ä¸Šé™åˆ°é”
                                {% endif %}
                            </span>
                        </div>
                        <div class="account-bar">
                            <div class="account-bar-fill" style="width: {{ (acc.today_follows / 60 * 100) | round }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- ã‚­ãƒ¥ãƒ¼çŠ¶æ³ã‚«ãƒ¼ãƒ‰ -->
            <section class="card queue-card" id="queueCard">
                <h2>ã‚­ãƒ¥ãƒ¼çŠ¶æ³</h2>
                <div class="queue-content" id="queueContent">
                    {% if current_job %}
                    <div class="queue-current">
                        <div class="queue-label">ç¾åœ¨ã®å‡¦ç†:</div>
                        <div class="queue-item queue-item-running">
                            <span class="queue-filename">{{ current_job.filename }}</span>
                            <span class="queue-progress">({{ current_job.progress }}/{{ current_job.total }})</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if queue_pending > 0 %}
                    <div class="queue-pending">
                        <div class="queue-label">å¾…ã¡: {{ queue_pending }}ä»¶</div>
                        <div class="queue-list" id="queueList">
                            <!-- JavaScriptã§å‹•çš„ã«æ›´æ–° -->
                        </div>
                    </div>
                    {% else %}
                    <div class="queue-empty" id="queueEmpty">
                        {% if not current_job %}
                        <p>ã‚­ãƒ¥ãƒ¼ã¯ç©ºã§ã™</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
            <section class="card status-card">
                <h2>å®Ÿè¡ŒçŠ¶æ³</h2>
                <div class="status-content">
                    <div class="status-indicator" id="statusIndicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span class="status-text" id="statusText">{{ state.status }}</span>
                    </div>

                    <div class="progress-info" id="progressInfo" style="display: none;">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <p class="progress-text">
                            <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
                        </p>
                        <p class="current-account">
                            ç¾åœ¨ãƒã‚§ãƒƒã‚¯ä¸­: <strong id="currentAccount">-</strong>
                        </p>
                    </div>

                    <div class="action-buttons">
                        <button id="stopBtn" class="btn btn-danger" style="display: none;" onclick="stopChecker()">
                            åœæ­¢
                        </button>
                    </div>
                </div>

                <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
                <div class="logs-container">
                    <h3>ãƒ­ã‚°</h3>
                    <div class="logs" id="logs">
                        <p class="log-empty">ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </section>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ -->
            <section class="card upload-card">
                <h2>CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fileInput" name="file" accept=".csv" hidden>
                        <div class="upload-icon">ğŸ“</div>
                        <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                        <p class="upload-hint">â€» 1åˆ—ç›®ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„</p>
                    </div>
                    <div class="selected-file" id="selectedFile" style="display: none;">
                        <span class="file-name" id="fileName"></span>
                        <button type="button" class="btn btn-small" onclick="clearFile()">å–æ¶ˆ</button>
                    </div>
                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                </form>

                <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ« -->
                <div class="uploaded-files">
                    <h3>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                    <div id="uploadedList">
                        <p class="empty-message">ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </section>

            <!-- Androidç”»é¢ãƒªãƒ³ã‚¯ -->
            <section class="card android-card">
                <h2>Androidç”»é¢</h2>
                <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§Androidã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®ç”»é¢ã‚’ç¢ºèªã§ãã¾ã™</p>
                <a id="androidScreenLink" href="#" target="_blank" class="btn btn-secondary">
                    Androidç”»é¢ã‚’é–‹ã (scrcpy-web)
                </a>
            </section>

            <!-- çµæœã‚«ãƒ¼ãƒ‰ -->
            <section class="card results-card">
                <h2>ãƒã‚§ãƒƒã‚¯çµæœ</h2>
                <div id="resultsList">
                    {% if results %}
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                    <th>ã‚µã‚¤ã‚º</th>
                                    <th>ä½œæˆæ—¥æ™‚</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td>{{ result.filename }}</td>
                                    <td>{{ (result.size / 1024) | round(1) }} KB</td>
                                    <td>{{ result.modified }}</td>
                                    <td>
                                        <a href="/results/{{ result.filename }}" class="btn btn-small">
                                            ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="empty-message">çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>
                    {% endif %}
                </div>
            </section>
        </main>

        <footer>
            <p>Instagramè©æ¬ºãƒã‚§ãƒƒã‚«ãƒ¼ v1.1.0 (Cloudç‰ˆ)</p>
        </footer>
    </div>

    <script>
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸscrcpyãƒãƒ¼ãƒˆ
        const scrcpyPort = "{{ scrcpy_port }}";

        // DOMè¦ç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const selectedFile = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const progressInfo = document.getElementById('progressInfo');
        const progressBar = document.getElementById('progressBar');
        const progressCurrent = document.getElementById('progressCurrent');
        const progressTotal = document.getElementById('progressTotal');
        const currentAccount = document.getElementById('currentAccount');
        const stopBtn = document.getElementById('stopBtn');
        const logs = document.getElementById('logs');

        let currentUploadedFile = null;
        let statusInterval = null;

        // Androidç”»é¢ãƒªãƒ³ã‚¯ã‚’å‹•çš„ã«è¨­å®šï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒç”¨ï¼‰
        const androidScreenLink = document.getElementById('androidScreenLink');
        androidScreenLink.href = `http://${window.location.hostname}:${scrcpyPort}`;

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯
        uploadArea.addEventListener('click', () => fileInput.click());

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            } else {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            fileName.textContent = file.name;
            selectedFile.style.display = 'flex';
            uploadArea.style.display = 'none';
            uploadBtn.disabled = false;
        }

        function clearFile() {
            fileInput.value = '';
            selectedFile.style.display = 'none';
            uploadArea.style.display = 'block';
            uploadBtn.disabled = true;
        }

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentUploadedFile = data.filename;
                    alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ' + data.filename);
                    loadUploadedFiles();
                    clearFile();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.detail);
                }
            } catch (error) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
            }
        });

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadUploadedFiles() {
            try {
                const response = await fetch('/uploads');
                const data = await response.json();

                const list = document.getElementById('uploadedList');

                if (data.uploads.length === 0) {
                    list.innerHTML = '<p class="empty-message">ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                list.innerHTML = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                <th>ã‚µã‚¤ã‚º</th>
                                <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.uploads.map(file => `
                                <tr>
                                    <td>${file.filename}</td>
                                    <td>${(file.size / 1024).toFixed(1)} KB</td>
                                    <td>${file.modified}</td>
                                    <td>
                                        <button class="btn btn-small btn-primary" onclick="startChecker('${file.filename}')">
                                            ãƒã‚§ãƒƒã‚¯é–‹å§‹
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—:', error);
            }
        }

        // ãƒã‚§ãƒƒã‚«ãƒ¼é–‹å§‹
        async function startChecker(filename) {
            if (!confirm(`"${filename}" ã®ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/start?filename=${encodeURIComponent(filename)}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    startStatusPolling();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.detail);
                }
            } catch (error) {
                alert('é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒã‚§ãƒƒã‚«ãƒ¼åœæ­¢
        async function stopChecker() {
            if (!confirm('ãƒã‚§ãƒƒã‚¯ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('/stop', { method: 'POST' });
                const data = await response.json();

                if (!response.ok) {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.detail);
                }
            } catch (error) {
                alert('åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        function startStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
            updateStatus();
            statusInterval = setInterval(updateStatus, 1000);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                statusText.textContent = data.status;

                if (data.is_running) {
                    statusDot.classList.add('running');
                    statusDot.classList.remove('completed', 'error');
                    progressInfo.style.display = 'block';
                    stopBtn.style.display = 'inline-block';

                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                    const percent = data.total > 0 ? (data.progress / data.total) * 100 : 0;
                    progressBar.style.width = percent + '%';
                    progressCurrent.textContent = data.progress;
                    progressTotal.textContent = data.total;
                    currentAccount.textContent = data.current_account || '-';
                } else {
                    statusDot.classList.remove('running');
                    if (data.status === 'å®Œäº†') {
                        statusDot.classList.add('completed');
                    } else if (data.status === 'ã‚¨ãƒ©ãƒ¼') {
                        statusDot.classList.add('error');
                    }
                    stopBtn.style.display = 'none';

                    // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
                    if (statusInterval && data.status !== 'å®Ÿè¡Œä¸­') {
                        clearInterval(statusInterval);
                        statusInterval = null;
                        // çµæœä¸€è¦§ã‚’æ›´æ–°
                        location.reload();
                    }
                }

                // ãƒ­ã‚°æ›´æ–°
                if (data.logs && data.logs.length > 0) {
                    logs.innerHTML = data.logs.map(log => `<p class="log-line">${log}</p>`).join('');
                    logs.scrollTop = logs.scrollHeight;
                } else {
                    logs.innerHTML = '<p class="log-empty">ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                }

            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã«å¤±æ•—:', error);
            }
        }

        // ã‚­ãƒ¥ãƒ¼çŠ¶æ³ã‚’æ›´æ–°
        async function updateQueueStatus() {
            try {
                const response = await fetch('/queue');
                const data = await response.json();

                const queueContent = document.getElementById('queueContent');

                let html = '';

                // ç¾åœ¨ã®å‡¦ç†
                if (data.current) {
                    html += `
                        <div class="queue-current">
                            <div class="queue-label">ç¾åœ¨ã®å‡¦ç†:</div>
                            <div class="queue-item queue-item-running">
                                <span class="queue-filename">${data.current.filename}</span>
                                <span class="queue-progress">(${data.current.progress}/${data.current.total})</span>
                                ${data.current.instagram_account ? `<span class="queue-account">@${data.current.instagram_account}</span>` : ''}
                            </div>
                        </div>
                    `;
                }

                // å¾…ã¡ã‚¸ãƒ§ãƒ–
                if (data.pending && data.pending.length > 0) {
                    html += `
                        <div class="queue-pending">
                            <div class="queue-label">å¾…ã¡: ${data.pending.length}ä»¶</div>
                            <div class="queue-list">
                                ${data.pending.map((job, index) => `
                                    <div class="queue-item queue-item-pending">
                                        <span class="queue-position">${index + 1}.</span>
                                        <span class="queue-filename">${job.filename}</span>
                                        <button class="btn btn-small btn-danger" onclick="cancelJob('${job.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (!data.current) {
                    html += '<div class="queue-empty"><p>ã‚­ãƒ¥ãƒ¼ã¯ç©ºã§ã™</p></div>';
                }

                queueContent.innerHTML = html;

                // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ³ã‚’æ›´æ–°
                if (data.accounts && data.accounts.length > 0) {
                    updateAccountsDisplay(data.accounts);
                }

            } catch (error) {
                console.error('ã‚­ãƒ¥ãƒ¼çŠ¶æ³å–å¾—ã«å¤±æ•—:', error);
            }
        }

        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ³è¡¨ç¤ºã‚’æ›´æ–°
        function updateAccountsDisplay(accounts) {
            const accountsGrid = document.querySelector('.accounts-grid');
            if (!accountsGrid) return;

            accountsGrid.innerHTML = accounts.map(acc => `
                <div class="account-item ${!acc.is_available ? 'account-exhausted' : ''}">
                    <div class="account-name">@${acc.username}</div>
                    <div class="account-stats">
                        <span class="follow-count">${acc.today_follows}/60</span>
                        <span class="follow-remaining">
                            ${acc.is_available ? `æ®‹ã‚Š${acc.remaining}å›` : 'ä¸Šé™åˆ°é”'}
                        </span>
                    </div>
                    <div class="account-bar">
                        <div class="account-bar-fill" style="width: ${Math.round(acc.today_follows / 60 * 100)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        // ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        async function cancelJob(jobId) {
            if (!confirm('ã“ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/queue/${jobId}`, { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    updateQueueStatus();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.detail);
                }
            } catch (error) {
                alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadUploadedFiles();
            updateStatus();
            updateQueueStatus();

            // å®Ÿè¡Œä¸­ãªã‚‰ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            fetch('/status')
                .then(res => res.json())
                .then(data => {
                    if (data.is_running || data.queue_pending > 0) {
                        startStatusPolling();
                    }
                });

            // ã‚­ãƒ¥ãƒ¼çŠ¶æ³ã¯å®šæœŸçš„ã«æ›´æ–°ï¼ˆ5ç§’ã”ã¨ï¼‰
            setInterval(updateQueueStatus, 5000);
        });
    </script>
</body>
</html>
