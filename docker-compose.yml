version: "3.8"

services:
  # ===========================================
  # Redroid - Android Emulator (Android 13, ARM64 Native)
  # ===========================================
  redroid:
    # SwiftShader 同梱ビルド（GPUなし環境向け）。arm64 ネイティブ。
    image: ghcr.io/fjsr3125/instagram-sagi-searcher-cloud-redroid:latest
    container_name: redroid
    privileged: true
    ports:
      # ADBポートはローカルのみ（セキュリティ対策）
      - "127.0.0.1:${REDROID_ADB_PORT:-5555}:5555"
    # binderfsをボリュームマウント（kernel 5.15+対応）
    volumes:
      - /dev/binderfs:/dev/binderfs
      - redroid-data:/data
    # androidboot.*はcommandで渡す（environmentでは反映されない）
    command:
      - androidboot.redroid_width=1080
      - androidboot.redroid_height=1920
      - androidboot.redroid_dpi=480
      - androidboot.redroid_fps=30
      # GPUなし環境なので SwiftShader を強制
      - androidboot.redroid_gpu_mode=guest
      - ro.hardware.egl=swiftshader
      - ro.hardware.hwcomposer=none
      - ro.hardware.keystore=software
      - ro.hardware.gatekeeper=software
      - ro.surface_flinger.disable_hwc=1
      - androidboot.use_memfd=1
      # binderfsパスを明示（kernel 5.15+対応）
      - androidboot.binder=/dev/binderfs/binder
      - androidboot.hwbinder=/dev/binderfs/hwbinder
      - androidboot.vndbinder=/dev/binderfs/vndbinder
    shm_size: "1g"
    mem_limit: "6g"
    cpus: "2.5"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "getprop sys.boot_completed | grep -q 1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 180s

  # ===========================================
  # Appium Server (固定バージョン)
  # ===========================================
  appium:
    image: ghcr.io/fjsr3125/instagram-sagi-searcher-cloud-appium:latest
    build:
      context: ./appium
      dockerfile: Dockerfile
    container_name: appium
    ports:
      # Appiumポートはローカルのみ（セキュリティ対策）
      - "127.0.0.1:${APPIUM_PORT:-4723}:4723"
    environment:
      - ANDROID_ADB_SERVER_ADDRESS=redroid
      - ANDROID_ADB_SERVER_PORT=5555
    volumes:
      - ./data/appium:/root/.appium
      - ./checker:/app/checker:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:4723/status | grep -Eq '\"ready\"\\s*:\\s*true' || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    depends_on:
      redroid:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: "1.5g"
    cpus: "0.75"
    command: >
      appium
      --address 0.0.0.0
      --port 4723
      --relaxed-security
      --allow-insecure chromedriver_autodownload
      --log-timestamp
      --log-no-colors

  # ===========================================
  # FastAPI Web UI
  # ===========================================
  web:
    image: ghcr.io/fjsr3125/instagram-sagi-searcher-cloud-web:latest
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: web-ui
    ports:
      - "${WEB_UI_PORT:-8000}:8000"
    environment:
      - APPIUM_HOST=appium
      - APPIUM_PORT=4723
      - REDROID_HOST=redroid
      - REDROID_ADB_PORT=5555
      - INSTAGRAM_ACCOUNTS=${INSTAGRAM_ACCOUNTS:-}
      - INSTAGRAM_USERNAME=${INSTAGRAM_USERNAME:-}
      - INSTAGRAM_PASSWORD=${INSTAGRAM_PASSWORD:-}
      - CHECK_DELAY=${CHECK_DELAY:-10}
      - BATCH_SIZE=${BATCH_SIZE:-20}
      - DEBUG=${DEBUG:-false}
    volumes:
      - ./web:/app
      - ./data:/app/data
      - ./checker:/app/checker:ro
    depends_on:
      appium:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: "512m"
    cpus: "0.5"
    command: uvicorn main:app --host 0.0.0.0 --port 8000

  # ===========================================
  # Caddy - HTTPS Reverse Proxy (Optional)
  # ===========================================
  # 使用する場合: .envにDOMAINを設定してください
  # 例: DOMAIN=insta-checker.duckdns.org
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    profiles:
      - https
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - web
    networks:
      - app-network
    restart: unless-stopped
    mem_limit: "128m"
    cpus: "0.25"

# ===========================================
# Networks
# ===========================================
networks:
  app-network:
    driver: bridge
    name: instagram-checker-network

# ===========================================
# Volumes
# ===========================================
volumes:
  redroid-data:
    name: instagram-checker-redroid-data
  caddy-data:
    name: instagram-checker-caddy-data
  caddy-config:
    name: instagram-checker-caddy-config
